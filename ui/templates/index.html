<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethereum Data Pipeline Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .pipeline-step {
            border-left: 4px solid #007bff;
            padding-left: 20px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        .pipeline-step.completed {
            border-left-color: #28a745;
            background-color: #f8fff9;
        }
        .pipeline-step.error {
            border-left-color: #dc3545;
            background-color: #fff8f8;
        }
        .status-badge {
            font-size: 0.8em;
            padding: 4px 8px;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
        }
        .artifact-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .loading {
            display: none;
        }
        .loading.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row bg-primary text-white py-4 mb-4">
            <div class="col">
                <h1 class="mb-0">
                    <i class="fas fa-project-diagram me-3"></i>
                    Ethereum Data Pipeline Demo
                </h1>
                <p class="mb-0 mt-2">Blockchain Data → Processing → IPFS → NFT</p>
            </div>
        </div>

        <div class="row">
            <!-- Main Pipeline Status -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3><i class="fas fa-cogs me-2"></i>Pipeline Status</h3>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshStatus()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button class="btn btn-sm btn-success" onclick="triggerRun()">
                                <i class="fas fa-play"></i> Run Pipeline
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="loading" id="statusLoading">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p>Loading pipeline status...</p>
                            </div>
                        </div>
                        <div id="pipelineStatus"></div>
                    </div>
                </div>

                <!-- Pipeline Steps -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-list-ol me-2"></i>Pipeline Steps</h3>
                    </div>
                    <div class="card-body">
                        <div id="pipelineSteps"></div>
                    </div>
                </div>
            </div>

            <!-- Sidebar with Artifacts -->
            <div class="col-lg-4">
                <!-- IPFS Information -->
                <div class="artifact-card">
                    <h4><i class="fas fa-cloud me-2"></i>IPFS Data</h4>
                    <div class="loading" id="ipfsLoading">
                        <div class="spinner-border spinner-border-sm text-primary"></div>
                    </div>
                    <div id="ipfsInfo"></div>
                </div>

                <!-- Blockchain Information -->
                <div class="artifact-card">
                    <h4><i class="fas fa-link me-2"></i>Blockchain</h4>
                    <div class="loading" id="blockchainLoading">
                        <div class="spinner-border spinner-border-sm text-primary"></div>
                    </div>
                    <div id="blockchainInfo"></div>
                </div>

                <!-- NFT Information -->
                <div class="artifact-card">
                    <h4><i class="fas fa-certificate me-2"></i>NFT</h4>
                    <div class="loading" id="nftLoading">
                        <div class="spinner-border spinner-border-sm text-primary"></div>
                    </div>
                    <div id="nftInfo"></div>
                </div>

                <!-- Transaction Data -->
                <div class="artifact-card">
                    <h4><i class="fas fa-exchange-alt me-2"></i>Sample Transactions</h4>
                    <div class="loading" id="transactionsLoading">
                        <div class="spinner-border spinner-border-sm text-primary"></div>
                    </div>
                    <div id="transactionsInfo"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global state
        let pipelineData = {};

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            // Auto-refresh every 30 seconds
            setInterval(loadAllData, 30000);
        });

        async function loadAllData() {
            await Promise.all([
                loadPipelineStatus(),
                loadIPFSInfo(),
                loadBlockchainInfo(),
                loadNFTInfo(),
                loadTransactionsInfo()
            ]);
        }

        async function loadPipelineStatus() {
            showLoading('statusLoading');
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                pipelineData = data;
                renderPipelineStatus(data);
                renderPipelineSteps(data);
            } catch (error) {
                console.error('Error loading pipeline status:', error);
                document.getElementById('pipelineStatus').innerHTML = 
                    '<div class="alert alert-danger">Error loading pipeline status</div>';
            } finally {
                hideLoading('statusLoading');
            }
        }

        async function loadIPFSInfo() {
            showLoading('ipfsLoading');
            try {
                const response = await fetch('/api/ipfs');
                const data = await response.json();
                renderIPFSInfo(data);
            } catch (error) {
                console.error('Error loading IPFS info:', error);
            } finally {
                hideLoading('ipfsLoading');
            }
        }

        async function loadBlockchainInfo() {
            showLoading('blockchainLoading');
            try {
                const response = await fetch('/api/blockchain');
                const data = await response.json();
                renderBlockchainInfo(data);
            } catch (error) {
                console.error('Error loading blockchain info:', error);
            } finally {
                hideLoading('blockchainLoading');
            }
        }

        async function loadNFTInfo() {
            showLoading('nftLoading');
            try {
                const response = await fetch('/api/nft');
                const data = await response.json();
                renderNFTInfo(data);
            } catch (error) {
                console.error('Error loading NFT info:', error);
            } finally {
                hideLoading('nftLoading');
            }
        }

        async function loadTransactionsInfo() {
            showLoading('transactionsLoading');
            try {
                const response = await fetch('/api/transactions');
                const data = await response.json();
                renderTransactionsInfo(data);
            } catch (error) {
                console.error('Error loading transactions info:', error);
            } finally {
                hideLoading('transactionsLoading');
            }
        }

        function renderPipelineStatus(data) {
            const statusDiv = document.getElementById('pipelineStatus');
            const statusClass = data.pipeline_status === 'completed' ? 'success' : 'warning';
            statusDiv.innerHTML = `
                <div class="alert alert-${statusClass}">
                    <i class="fas fa-${data.pipeline_status === 'completed' ? 'check-circle' : 'exclamation-triangle'}"></i>
                    <strong>Pipeline Status: ${data.pipeline_status.toUpperCase()}</strong>
                    <br><small>Last updated: ${new Date(data.timestamp).toLocaleString()}</small>
                </div>
            `;
        }

        function renderPipelineSteps(data) {
            const stepsDiv = document.getElementById('pipelineSteps');
            const steps = [
                { key: 'etherscan_ingestion', name: 'Etherscan Data Ingestion', icon: 'fas fa-download' },
                { key: 'spark_processing', name: 'PySpark Processing', icon: 'fas fa-cogs' },
                { key: 'ipfs_pinning', name: 'IPFS Pinning', icon: 'fas fa-cloud-upload-alt' },
                { key: 'nft_deployment', name: 'NFT Contract Deployment', icon: 'fas fa-rocket' },
                { key: 'nft_minting', name: 'NFT Minting', icon: 'fas fa-certificate' }
            ];

            stepsDiv.innerHTML = steps.map(step => {
                const stepData = data.steps[step.key];
                const statusClass = stepData.status === 'completed' ? 'completed' : 'error';
                return `
                    <div class="pipeline-step ${statusClass}">
                        <h5>
                            <i class="${step.icon} me-2"></i>
                            ${step.name}
                            <span class="badge bg-${stepData.status === 'completed' ? 'success' : 'danger'} status-badge">
                                ${stepData.status.toUpperCase()}
                            </span>
                        </h5>
                        <p class="mb-0">${stepData.message}</p>
                    </div>
                `;
            }).join('');
        }

        function renderIPFSInfo(data) {
            document.getElementById('ipfsInfo').innerHTML = `
                <p><strong>CID:</strong> <code>${data.cid}</code></p>
                <p><strong>Gateway URL:</strong> 
                    <a href="${data.gateway_url}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-external-link-alt"></i> View
                    </a>
                </p>
                <p><strong>IPFS URI:</strong> <code>${data.ipfs_uri}</code></p>
                <p><strong>Status:</strong> 
                    <span class="badge bg-${data.accessible ? 'success' : 'danger'}">
                        ${data.accessible ? 'Accessible' : 'Not Accessible'}
                    </span>
                </p>
                ${data.sample_data ? `
                    <div class="mt-3">
                        <h6>Sample Data:</h6>
                        <div class="code-block">${data.sample_data}</div>
                    </div>
                ` : ''}
            `;
        }

        function renderBlockchainInfo(data) {
            document.getElementById('blockchainInfo').innerHTML = `
                <p><strong>RPC URL:</strong> <code>${data.rpc_url}</code></p>
                <p><strong>Block Number:</strong> ${data.block_number}</p>
                <p><strong>NFT Contract:</strong> <code>${data.nft_contract}</code></p>
                <p><strong>Recipient:</strong> <code>${data.recipient}</code></p>
                <p><strong>Contract Status:</strong> 
                    <span class="badge bg-${data.contract_deployed ? 'success' : 'danger'}">
                        ${data.contract_deployed ? 'Deployed' : 'Not Deployed'}
                    </span>
                </p>
                ${data.contract_name ? `<p><strong>Contract Name:</strong> ${data.contract_name}</p>` : ''}
            `;
        }

        function renderNFTInfo(data) {
            document.getElementById('nftInfo').innerHTML = `
                <p><strong>Contract:</strong> <code>${data.contract_address}</code></p>
                <p><strong>Token ID:</strong> ${data.token_id}</p>
                <p><strong>Owner:</strong> <code>${data.owner}</code></p>
                <p><strong>Token URI:</strong> <code>${data.token_uri}</code></p>
                <p><strong>Mint TX:</strong> 
                    <code title="${data.mint_transaction}">${data.mint_transaction.substring(0, 20)}...</code>
                </p>
                <p><strong>Metadata:</strong> 
                    <span class="badge bg-${data.metadata_accessible ? 'success' : 'warning'}">
                        ${data.metadata_accessible ? 'Accessible' : 'Unknown'}
                    </span>
                </p>
            `;
        }

        function renderTransactionsInfo(data) {
            if (data.sample_transactions) {
                document.getElementById('transactionsInfo').innerHTML = `
                    <p><strong>Total Transactions:</strong> ${data.total_transactions}</p>
                    <h6>Sample Transactions:</h6>
                    ${data.sample_transactions.map(tx => `
                        <div class="border rounded p-2 mb-2">
                            <p class="mb-1"><strong>Hash:</strong> <code>${tx.hash.substring(0, 20)}...</code></p>
                            <p class="mb-1"><strong>Value:</strong> ${tx.value}</p>
                            <p class="mb-1"><strong>Block:</strong> ${tx.block}</p>
                            <p class="mb-0"><strong>Time:</strong> ${new Date(tx.timestamp).toLocaleString()}</p>
                        </div>
                    `).join('')}
                `;
            } else {
                document.getElementById('transactionsInfo').innerHTML = 
                    '<div class="alert alert-warning">No transaction data available</div>';
            }
        }

        function showLoading(elementId) {
            document.getElementById(elementId).classList.add('show');
        }

        function hideLoading(elementId) {
            document.getElementById(elementId).classList.remove('show');
        }

        function refreshStatus() {
            loadAllData();
        }

        async function triggerRun() {
            try {
                const res = await fetch('/api/run', { method: 'POST' });
                if (res.status === 202) {
                    showRunLogs();
                    // Start polling status/logs
                    pollRunLogs();
                } else {
                    const data = await res.json();
                    alert(data.message || 'Unable to start pipeline');
                }
            } catch (e) {
                alert('Failed to start pipeline');
            }
        }

        async function pollRunLogs() {
            try {
                const res = await fetch('/api/run/status');
                const data = await res.json();
                document.getElementById('runLogsBody').textContent = data.logs || '';
                if (data.running) {
                    setTimeout(pollRunLogs, 2000);
                } else {
                    // When complete, refresh dashboard
                    loadAllData();
                }
            } catch (e) {
                // try again shortly
                setTimeout(pollRunLogs, 3000);
            }
        }

        function showRunLogs() {
            const modal = new bootstrap.Modal(document.getElementById('runLogsModal'));
            modal.show();
        }
    </script>

    <!-- Run Logs Modal -->
    <div class="modal fade" id="runLogsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-terminal me-2"></i>Pipeline Run Logs</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <pre class="code-block" id="runLogsBody"></pre>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
</body>
</html>
